<!-- Consent-based Device Status Logger with Hidden Logs and Database Integration -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Device Status Logger — Auto-Permissions</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7dd3fc;--muted:#94a3b8}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:0;min-height:100vh;background:linear-gradient(180deg,#021025 0%, #071226 100%);color:#e6eef7}
    .wrap{max-width:900px;margin:48px auto;padding:24px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 8px;font-size:1.4rem}
    p.lead{margin:0 0 16px;color:var(--muted)}
    .consent{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    label{display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(125,211,252,0.12);padding:10px 14px;border-radius:8px;color:var(--accent);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,#0369a1,#0891b2);color:white;border:0}
    .cols{display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    pre{white-space:pre-wrap;word-wrap:break-word;font-size:13px}
    .log{display:none;height:420px;overflow:auto;background:#041022;padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.3)}
    footer{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
    #viewBtn{display:block;margin:40px auto 0 auto;background:#0369a1;color:white;border:0;padding:10px 20px;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <h1>Device Status Logger — Auto-Permissions (Your Device)</h1>
    <p class="lead">Automatically requests permissions, collects device info, and logs results. Only use on devices you own.</p>

    <div class="consent card">
      <label>
        <input id="agree" type="checkbox" checked />
        <div>
          <strong>Auto-consent (for this device)</strong>
          <div style="font-size:13px;color:var(--muted)">Checked by default. Permissions still require browser confirmation.</div>
        </div>
      </label>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="collectBtn" class="btn primary">Collect & Send</button>
        <button id="collectLocal" class="btn">Collect Locally</button>
      </div>
    </div>

    <div class="cols">
      <div>
        <div class="card">
          <h3 style="margin-top:0">Requested permissions</h3>
          <div id="fields"></div>
        </div>
      </div>
      <div>
        <div class="card">
          <h3 style="margin-top:0">Live log</h3>
          <div id="log" class="log"></div>
        </div>
      </div>
    </div>

    <button id="viewBtn">View Logs</button>
    <footer>Only for authorized use. Data stored locally and viewable with access key.</footer>
  </div>

  <script>
    const agree=document.getElementById('agree');
    const collectBtn=document.getElementById('collectBtn');
    const collectLocal=document.getElementById('collectLocal');
    const log=document.getElementById('log');

    function appendLog(t){const e=document.createElement('div');e.textContent='['+new Date().toISOString()+'] '+t;log.prepend(e)}

    function gatherBasic(){const n=navigator;return{collectedAt:new Date().toISOString(),userAgent:n.userAgent,platform:n.platform,languages:n.languages||[n.language],cores:n.hardwareConcurrency,deviceMemoryGB:n.deviceMemory,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone}};

    async function collectAll(send){if(!agree.checked)return appendLog('Consent required');const p=gatherBasic();appendLog('Collected basic info');document.getElementById('fields').innerHTML='<div><small>'+JSON.stringify(p,null,2)+'</small></div>';if(send){await fetch('/logs',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(p,null,2)}).then(r=>appendLog('Logs sent')).catch(e=>appendLog('Send failed '+e))}}

    collectBtn.onclick=()=>collectAll(true);
    collectLocal.onclick=()=>collectAll(false);

    document.getElementById('viewBtn').onclick=async()=>{
      const key=prompt('Enter access key to view logs:');
      if(key!=='54321'){alert('Wrong key');return;}
      const res=await fetch('/view?key='+key);
      if(!res.ok)return alert('Access denied');
      const data=await res.json();
      log.style.display='block';
      log.innerHTML='';
      data.forEach(d=>{
        const div=document.createElement('div');
        div.textContent=`${new Date(d.time).toLocaleString()} — ${d.device}`;
        log.appendChild(div);
      });
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    };
  </script>
</body>
</html>
